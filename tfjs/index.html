<html>

<head>
    <title>MNIST TF.js</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
</head>

<body>
<h1 id='text_area'></h1>
<div id='main'>
<div class="sketch_area" style="height: 50%; width: 45%; float: left;">
    <canvas id="pad" width="500" height="500" style="border:1px solid #000000;"></canvas>
</div>
<div class="chart_area" style="height: 50%; width: 45%; float: left;">
    <canvas id="acc_chart"></canvas>
</div>
</div>
<script>
    var clickX = [];
    var clickY = [];
    var clickDrag = [];
    var paint;
    
    var canvas = document.getElementById("pad");
    var context = canvas.getContext("2d");

    var result_list = [];
    var full_length = 0;
    var run_classifier_times = 0;
    var run_classifier_length = 25;
    
    var num_label = Math.floor(Math.random() * (10) );
    
    press = async function (e) {
        paint = true;
        var mouseX = (e.changedTouches ? e.changedTouches[0].pageX : e.pageX) - this.offsetLeft;
        var mouseY = (e.changedTouches ? e.changedTouches[0].pageY : e.pageY) - this.offsetTop;
        addClick(mouseX, mouseY, false);
        // console.log('draw starts');
        redraw();
        // console.log('draw ends');
        if (full_length > (run_classifier_times+1)*run_classifier_length){
            // console.log('do one classification');
            await classify();
            run_classifier_times++;
            // console.log('heavy job done '+run_classifier_times);
        }
        full_length = 0;
    };

    drag = async function (e) {
        if (paint) {
            var mouseX = (e.changedTouches ? e.changedTouches[0].pageX : e.pageX) - this.offsetLeft;
            var mouseY = (e.changedTouches ? e.changedTouches[0].pageY : e.pageY) - this.offsetTop;
            addClick(mouseX, mouseY, true);
            // console.log('draw starts');
            redraw();
            // console.log('draw ends');
            if (full_length > (run_classifier_times+1)*run_classifier_length){
                // console.log('do one classification');
                await classify();
                run_classifier_times++;
                // console.log('heavy job done '+run_classifier_times);
            }
            full_length = 0;
        }
        e.preventDefault();
    };

    release = function () {
        paint = false;
    };

    cancel = function () {
        paint = false;
    };

    function addClick(x, y, dragging) {
        clickX.push(x);
        clickY.push(y);
        clickDrag.push(dragging);
    }

    function redraw() {
        context.clearRect(0, 0, context.width, context.height);

        context.strokeStyle = "#000000";
        context.lineJoin = "round";
        context.lineWidth = 50;

        for (var i = 0; i < clickX.length; i++) {
            context.beginPath();
            if (clickDrag[i] && i) {
                x1 = clickX[i - 1];
                y1 = clickY[i - 1];
            } else {
                x1 = clickX[i] - 1;
                y1 = clickY[i];
            }
            context.moveTo(x1, y1);
            x2 = clickX[i];
            y2 = clickY[i];
            context.lineTo(x2, y2);
            context.closePath();
            context.stroke();
            full_length = full_length + Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));
        }
        
    }    

    canvas.addEventListener("mousedown", press, false);
    canvas.addEventListener("mousemove", drag, false);
    canvas.addEventListener("mouseup", release);
    canvas.addEventListener("mouseout", cancel, false);

    canvas.addEventListener("touchstart", press, false);
    canvas.addEventListener("touchmove", drag, false);
    canvas.addEventListener("touchend", release, false);
    canvas.addEventListener("touchcancel", cancel, false);

    async function loadModel(){
        model = await tf.loadLayersModel('./model.json');
        return model;
    }

    model = loadModel();

    model.then(function(){warm_up = classify();document.getElementById("text_area").innerHTML = ('Draw Digit ' + num_label);});

    async function classify() {
        img = tf.browser.fromPixels(canvas,4).cast('float32').div(255).sum(axis=-1, keepDims=true);
        img_resized = tf.image.resizeBilinear(img, [28,28]);
        prediction = model.predict(img_resized.squeeze().expandDims(0));
        const prediction_js = await prediction.array();
        current_acc = prediction_js[0][num_label]*100;
        result_list.push(current_acc);
        chart.data.datasets[0].data.push(current_acc);
        chart.data.labels.push(run_classifier_times);
        chart.update();
    }

    var ctx = document.getElementById("acc_chart").getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Acc.',
                data: [],
            }]
        },
    });
</script> 
</body>

</html>
